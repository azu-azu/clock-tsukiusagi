# ğŸ§¾ `report-audio-phase1-foundation.md`

**TsukiUsagi Audio System â€“ Phase 1 é–‹ç™ºãƒ¬ãƒãƒ¼ãƒˆ**
ğŸ“… 2025-11-10
ğŸ‘©â€ğŸ’» Author: Azu
ğŸ·ï¸ Tag: `audio-architecture-phase1-complete`
ğŸ“‚ Location: `Docs/report/report-audio-phase1-foundation.md`

---

## ğŸ¯ Summary

Phase 1 ã§ã¯ã€Audio ã‚·ã‚¹ãƒ†ãƒ ã®**åŸºç›¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å†è¨­è¨ˆ**ã‚’è¡Œã£ãŸã€‚
ç›®çš„ã¯ã€ŒViewã«ä¾å­˜ã—ãªã„é•·å¯¿å‘½ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ³ã‚¸ãƒ³ã€ã‚’å®Ÿç¾ã—ã€ç”»é¢é·ç§»ã‚„ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹å¤‰åŒ–ã«è€ãˆã‚‹æ§‹é€ ã‚’ä½œã‚‹ã“ã¨ã€‚

çµæœã¨ã—ã¦ã€`AudioService` ã‚’ä¸­å¿ƒã¨ã™ã‚‹ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç¢ºç«‹ã—ã€
ã‚¢ãƒ—ãƒªå…¨ä½“ã§ã®å®‰å®šã—ãŸéŸ³å£°åˆ¶å¾¡ã‚’å®Ÿç¾ã—ãŸã€‚

---

## ğŸ—ï¸ 1. Context â€” Before Redesign

| å•é¡Œç‚¹ | è©³ç´° |
|--------|------|
| ğŸ›ï¸ Viewä¾å­˜ | å„ç”»é¢ (`AudioPlaybackView` ãªã©) ãŒç‹¬è‡ªã« `LocalAudioEngine` ã‚’ç”Ÿæˆã€‚ |
| ğŸ”‡ ç ´æ£„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å•é¡Œ | ViewãŒé–‰ã˜ã‚‹ãŸã³ã«ã‚¨ãƒ³ã‚¸ãƒ³ãŒç ´æ£„ã•ã‚Œã€éŸ³ãŒæ­¢ã¾ã‚‹ã€‚ |
| âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç«¶åˆ | å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ `AVAudioSession.setActive(true)` ã‚’ç¹°ã‚Šè¿”ã™ãŸã‚ã€`OSStatus -50` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚ |
| ğŸ§  çŠ¶æ…‹å…±æœ‰ãªã— | ç¾åœ¨ã®å†ç”ŸçŠ¶æ…‹ã‚„å‡ºåŠ›çµŒè·¯ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã§æŠŠæ¡ã§ããªã„ã€‚ |
| ğŸ§ å‡ºåŠ›ç›£è¦–ãªã— | ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³â†’ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å®‰å…¨åœæ­¢ãŒã§ããªã„ã€‚ |

ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ã€Œ**Viewã”ã¨ã«ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒé–‰ã˜ã¦ã„ã‚‹**ã€ã“ã¨ã«èµ·å› ã—ã¦ã„ãŸã€‚

---

## ğŸ§± 2. Goal â€” Redesign Direction

1. **ã‚¢ãƒ—ãƒªå…¨ä½“ã«1ã¤ã ã‘å­˜åœ¨ã™ã‚‹AudioServiceã‚’è¨­è¨ˆ**
2. **Viewãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨åˆ‡ã‚Šé›¢ã—ãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆ¶å¾¡**
3. **ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³å®‰å…¨æ¤œçŸ¥ã‚’è¿½åŠ **
4. **éŸ³å£°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¸€å…ƒç®¡ç†**
5. **å°†æ¥ã®QuietBreakSchedulerãªã©ã‚’è¦‹è¶Šã—ãŸåŸºç›¤åŒ–**

---

## ğŸ§© 3. Implementation

### 3.1 AudioService â€” Singleton Core

| ãƒ•ã‚¡ã‚¤ãƒ« | `Core/Audio/AudioService.swift` |
|-----------|--------------------------------|
| æ¦‚è¦ | ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’é€šã—ã¦éŸ³å£°åˆ¶å¾¡ã‚’è¡Œã†å”¯ä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚ |
| ä¸»ãªæ©Ÿèƒ½ | å†ç”Ÿãƒ»åœæ­¢ãƒ»ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ï¼ãƒ«ãƒ¼ãƒˆç›£è¦–ï¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼çŠ¶æ…‹å…±æœ‰ |
| SwiftUIçµ±åˆ | `@StateObject AudioService.shared` ã‚’ App ã«æ³¨å…¥ã€‚ |

ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼š
```swift
@Published private(set) var isPlaying: Bool
@Published private(set) var outputRoute: AudioOutputRoute
@Published private(set) var pauseReason: PauseReason?
````

ç‰¹å¾´ï¼š

* ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¡ç”¨
* ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸€åº¦ã ã‘å®Ÿè¡Œ
* Viewã®ç ´æ£„ã¨ç„¡é–¢ä¿‚ã«å‹•ä½œã‚’ç¶™ç¶š

---

### 3.2 AudioRouteMonitor â€” å‡ºåŠ›çµŒè·¯ç›£è¦–

| ãƒ•ã‚¡ã‚¤ãƒ« | `Core/Services/Route/AudioRouteMonitor.swift` |
| ---- | --------------------------------------------- |
| æ©Ÿèƒ½   | å‡ºåŠ›çµŒè·¯ï¼ˆãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ï¼Bluetoothï¼ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ï¼‰ã‚’æ¤œçŸ¥ã—ã€å®‰å…¨åˆ¶å¾¡ã‚’è¡Œã†ã€‚     |

ä¸»è¦ãƒ­ã‚¸ãƒƒã‚¯ï¼š

```swift
guard reason == .oldDeviceUnavailable else { return }
if wasHeadphoneType && currentRoute == .speaker {
    if settings.onlyHeadphoneOutput {
        onSpeakerSafety?() // å®‰å…¨åœæ­¢
    }
}
```

æ”¹å–„ç‚¹ï¼š

* ã‚¢ãƒ—ãƒªèµ·å‹•ç›´å¾Œã«ãƒ«ãƒ¼ãƒˆã‚’å³æ™‚æ¤œå‡ºï¼ˆä»¥å‰ã¯Unknownï¼‰
* é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å…¨çµŒè·¯å¤‰åŒ–ã«å¯¾å¿œ
* ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼å‡ºåŠ›æ™‚ã«è‡ªå‹•åœæ­¢

---

### 3.3 AudioSettings â€” æ°¸ç¶šåŒ–ã•ã‚ŒãŸè¨­å®š

| ãƒ•ã‚¡ã‚¤ãƒ« | `Core/Settings/AudioSettings.swift`         |
| ---- | ------------------------------------------- |
| æ©Ÿèƒ½   | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã€è‡ªå‹•å†é–‹ãªã©ï¼‰ã‚’UserDefaultsã«ä¿å­˜ï¼èª­è¾¼ |

```swift
struct AudioSettings: Codable {
    var onlyHeadphoneOutput: Bool = true
    var autoResumeAfterInterruption: Bool = true
}
```

---

### 3.4 App Integration

| ãƒ•ã‚¡ã‚¤ãƒ« | `App/clock_tsukiusagiApp.swift`                                          |
| ---- | ------------------------------------------------------------------------ |
| å¯¾å¿œ   | `@StateObject audioService = AudioService.shared` ã‚’æ³¨å…¥ã—ã€ã™ã¹ã¦ã®Viewã§å…±é€šåˆ©ç”¨å¯èƒ½ã«ã€‚ |

```swift
@main
struct clock_tsukiusagiApp: App {
    @StateObject private var audioService = AudioService.shared
    var body: some Scene {
        WindowGroup {
            ContentView().environmentObject(audioService)
        }
    }
}
```

---

## ğŸ” 4. Issues & Fixes

| No | å•é¡Œ                 | åŸå›                                  | è§£æ±ºç­–                            |
| -- | ------------------ | ---------------------------------- | ------------------------------ |
| 1  | OSStatus -50 ã‚¨ãƒ©ãƒ¼   | `.allowBluetooth` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒ iOS å®Ÿæ©Ÿã§ç„¡åŠ¹ | `.mixWithOthers` ã®ã¿ã«å¤‰æ›´         |
| 2  | å‡ºåŠ›ãƒ«ãƒ¼ãƒˆãŒ Unknown ã«ãªã‚‹ | èµ·å‹•æ™‚ã«ãƒ«ãƒ¼ãƒˆæœªæ¤œå‡º                         | `AudioService.init()` ã§åˆæœŸæ¤œå‡ºã‚’è¿½åŠ  |
| 3  | å®‰å…¨åœæ­¢ãŒé »ç¹ã«èª¤ç™ºå‹•        | å…¨ãƒ«ãƒ¼ãƒˆå¤‰æ›´ã§Pauseã—ã¦ã„ãŸ                   | `.oldDeviceUnavailable` ã®ã¿ã«é™å®š  |
| 4  | äºŒé‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–         | Engineå´ã¨Serviceå´ä¸¡æ–¹ã§`setActive`     | Engineå´ã‹ã‚‰å‰Šé™¤ã€Serviceå´ã®ã¿æœ‰åŠ¹åŒ–      |

---

## ğŸ§ 5. Testing Results (Device)

âœ… å†ç”Ÿä¸­ã«ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚éŸ³ãŒæ­¢ã¾ã‚‰ãªã„
âœ… ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ã‚’æŠœãã¨å®‰å…¨åœæ­¢ãŒå‹•ä½œ
âœ… ã‚¢ãƒ—ãƒªã‚’ãƒ­ãƒƒã‚¯ï¼è§£é™¤ã—ã¦ã‚‚çŠ¶æ…‹ä¿æŒ
âœ… è¨­å®šãŒå†èµ·å‹•å¾Œã‚‚ä¿æŒ
âœ… 2æ™‚é–“é€£ç¶šå†ç”Ÿã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãªã—

---

## ğŸ’¡ 6. Lessons Learned

| è¦³ç‚¹           | å­¦ã³                                           |
| ------------ | -------------------------------------------- |
| AudioSession | `.allowBluetooth` ã¯iOSä¾å­˜ã€‚ã¾ãšã¯æœ€å°æ§‹æˆã§å®‰å®šåŒ–ã•ã›ã‚‹ã®ãŒæ­£è§£ã€‚ |
| è²¬å‹™åˆ†é›¢         | AudioServiceã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€Engineã¯å†ç”Ÿåˆ¶å¾¡ã®ã¿ã€‚äºŒé‡ç®¡ç†ã¯é¿ã‘ã‚‹ã€‚ |
| åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°     | èµ·å‹•ç›´å¾Œã«ã€ŒçŠ¶æ…‹ã‚’ç¢ºå®šã€ã•ã›ã¦ãŠãã¨UIåŒæœŸãŒæ¥½ã€‚                    |
| å®‰å…¨æ©Ÿæ§‹         | UIæ›´æ–°ã¨å®‰å…¨åœæ­¢ã‚’åˆ†é›¢ï¼ˆé€šçŸ¥ã¨å‹•ä½œã‚’åˆ¥ã€…ã«å‡¦ç†ï¼‰ã€‚                   |

---

## ğŸ”— 7. Related Commits

* `b03c53b` â€“ fix: improve audio route detection timing and real-time updates
* `5ca8960` â€“ docs: add Issue 3 (route detection timing) to design doc
* `cbab26c` â€“ feat: implement AudioService singleton
* `4ce2b50` â€“ refactor: restructure CrossFeatureUI for audio integration

---

## ğŸš€ 8. Next Phase Preview (Phase 2)

Phase 2ã§ã¯ä»¥ä¸‹ã®æ‹¡å¼µã‚’è¨ˆç”»ã—ãŸï¼š

* QuietBreakSchedulerï¼ˆ55/5åˆ†è‡ªå‹•ã‚µã‚¤ã‚¯ãƒ«ï¼‰
* SafeVolumeLimiterï¼ˆéŸ³é‡ä¸Šé™ï¼‰
* ãƒ•ã‚§ãƒ¼ãƒ‰åˆ¶å¾¡ã®å®Ÿè£…
* è¨­å®šç”»é¢ã§ã®åˆ¶å¾¡UIè¿½åŠ 

Phase 1ã§æ§‹ç¯‰ã—ãŸAudioServiceæ§‹é€ ãŒã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½è¿½åŠ ã®åŸºç›¤ã«ãªã‚‹ã€‚

---

## ğŸ Conclusion

Audioã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ãŒå®‰å®šã—ã€
ã€Œå†ç”ŸçŠ¶æ…‹ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã§ç¶­æŒã§ãã‚‹ã€æ§‹é€ ã‚’ç¢ºç«‹ã€‚
Phase 1ã®ç›®çš„ã¯ã™ã¹ã¦é”æˆã•ã‚ŒãŸã€‚

> ğŸ’¬ *â€œéŸ³ãŒæ­¢ã¾ã‚‰ãªã„â€ ã¯ã€UIã‚ˆã‚Šã‚‚å¤§åˆ‡ãªä¿¡é ¼æ„Ÿã€‚*
>
> * TsukiUsagi Audio System Foundation å®Œäº† ğŸ‡ğŸŒ™
