# Transpose Guide â€” ç§»èª¿ã®æ­£ã—ã„å®Ÿè£…æ–¹æ³•

**Version**: 1.0
**Last Updated**: 2025-11-30
**Purpose**: éŸ³æ¥½æ§‹é€ ã‚’ç ´å£Šã›ãšã«ç§»èª¿ã‚’è¡Œã†ãŸã‚ã®ã‚¬ã‚¤ãƒ‰

---

## What is Transpose? â€” ç§»èª¿ã¨ã¯

> ç§»èª¿ã¨ã¯ã€æ¥½æ›²ã®**ã™ã¹ã¦ã®éŸ³ã‚’åŒã˜éŸ³ç¨‹ã ã‘**ä¸Šã’ä¸‹ã’ã™ã‚‹ã“ã¨ã€‚
> éŸ³ã¨éŸ³ã®**è·é›¢ï¼ˆåº¦æ•°ãƒ»intervalï¼‰ã¯å®Œå…¨ã«ä¿æŒ**ã•ã‚Œã‚‹ã€‚
> ãƒ¡ãƒ­ãƒ‡ã‚£ã®ã€Œå½¢ã€ã¯å¤‰ã‚ã‚‰ãšã€ã€Œé«˜ã•ã€ã ã‘ãŒå¤‰ã‚ã‚‹ã€‚

---

## ğŸ”¥ ç§»èª¿ã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«

1. **å‘¨æ³¢æ•°ã«ä¿‚æ•°ã‚’ã‹ã‘ã‚‹ã ã‘** â€” æ§‹é€ ã¯ä¸€åˆ‡è§¦ã‚‰ãªã„
2. **éŸ³åï¼ˆPitch enumï¼‰ã‚’æ›¸ãæ›ãˆãªã„** â€” åå‰ã¨å‘¨æ³¢æ•°ã®å¯¾å¿œã‚’å£Šã™ãª
3. **ãƒ¡ãƒ­ãƒ‡ã‚£é…åˆ—ã‚’æ›¸ãæ›ãˆãªã„** â€” åº¦æ•°é–¢ä¿‚ã‚’å£Šã™ãª

---

## âœ… æ­£ã—ã„ç§»èª¿ã®å®Ÿè£…

### ä¿‚æ•°ã®è¨ˆç®—å¼

```
transposeFactor = 2^(n/12)
```

| ç§»èª¿é‡ | ä¿‚æ•° | ä¾‹ |
|--------|------|-----|
| +1åŠéŸ³ | 2^(1/12) â‰ˆ 1.0595 | C â†’ C# |
| +2åŠéŸ³ | 2^(2/12) â‰ˆ 1.1225 | C â†’ D |
| -1åŠéŸ³ | 2^(-1/12) â‰ˆ 0.9439 | C â†’ B |
| -2åŠéŸ³ | 2^(-2/12) â‰ˆ 0.8909 | C â†’ Bb |
| -3åŠéŸ³ | 2^(-3/12) â‰ˆ 0.8409 | C â†’ A |

### Swiftå®Ÿè£…ä¾‹

```swift
// ç§»èª¿ä¿‚æ•°ã‚’å®šç¾©ï¼ˆ-2åŠéŸ³ã®ä¾‹ï¼‰
let transposeFactor: Float = pow(2.0, -2.0 / 12.0)

// ä½¿ç”¨æ™‚ã«å‘¨æ³¢æ•°ã«ã‹ã‘ã‚‹
let transposedFreq = note.freq * transposeFactor

// ãƒˆãƒ¼ãƒ³ç”Ÿæˆã«æ¸¡ã™
totalSignal += generateTone(freq: transposedFreq, t: t) * envelope
```

### å¤‰æ›´ç®‡æ‰€

```swift
// âŒ é–“é•ã„: Pitch enumã‚’æ›¸ãæ›ãˆã‚‹
enum Pitch: Float {
    case E4 = 277.18   // was 329.63 â† ãƒ€ãƒ¡ï¼
    case G4 = 329.63   // was 392.00 â† ãƒ€ãƒ¡ï¼
}

// âŒ é–“é•ã„: ãƒ¡ãƒ­ãƒ‡ã‚£é…åˆ—ã‚’æ›¸ãæ›ãˆã‚‹
let melody: [Note] = [
    Note(.C_4, .eighth),  // E4 â†’ C#4 ã«å¤‰ãˆãŸ â† ãƒ€ãƒ¡ï¼
    Note(.E4, .eighth),   // G4 â†’ E4 ã«å¤‰ãˆãŸ â† ãƒ€ãƒ¡ï¼
]

// âœ… æ­£ã—ã„: ä¿‚æ•°ã‚’ã‹ã‘ã‚‹ã ã‘
let transposedFreq = note.freq * transposeFactor
```

---

## âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨

### 1. Pitch enumã®åå‰ã‚’å¤‰ãˆã‚‹

```swift
// âŒ ã‚¢ã‚¦ãƒˆ
case C_4 = 277.18  // C#4 (was E4)
case E4 = 329.63   // E4 (was G4)
```

ã“ã‚Œã¯ã€Œåˆ¥ã®éŸ³éšã®åˆ¥ãƒ¡ãƒ­ãƒ‡ã‚£ã€ã‚’ä½œã£ã¦ã—ã¾ã†ã€‚

### 2. ãƒ¡ãƒ­ãƒ‡ã‚£é…åˆ—ã‚’æ›¸ãæ›ãˆã‚‹

```swift
// å…ƒ: E4, G4, A4 ï¼ˆé•·3åº¦ + é•·2åº¦ï¼‰
// âŒ æ›¸ãæ›ãˆå¾Œ: C#4, E4, F#4

// åº¦æ•°é–¢ä¿‚ãŒå´©å£Šã—ã¦ã„ã‚‹ï¼
// ã“ã‚Œã¯ç§»èª¿ã§ã¯ãªãã€Œæ”¹ä½œã€
```

### 3. é–¢é€£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã€Œæ›¸ãæ›ã‚ã£ãŸå€¤ã€ã«åˆã‚ã›ã‚‹

ç§»èª¿ã§æœ€é«˜éŸ³ãŒå¤‰ã‚ã£ãŸã‹ã‚‰ã¨ã„ã£ã¦ã€é«˜éŸ³åŸŸã‚²ã‚¤ãƒ³èª¿æ•´ã®é–¾å€¤ã‚’å¤‰ãˆã‚‹å¿…è¦ã¯ãªã„ã€‚
å…ƒã®è¨­è¨ˆæ„å›³ã«åŸºã¥ã„ã¦åˆ¤æ–­ã™ã‚‹ã€‚

---

## ãªãœä¿‚æ•°æ–¹å¼ãŒæ­£ã—ã„ã®ã‹

### éŸ³æ¥½ç†è«–çš„æ ¹æ‹ 

ç§»èª¿ã®æœ¬è³ªã¯ **åº¦æ•°ï¼ˆintervalï¼‰ã®ä¿æŒ**ã€‚

```
å…ƒã®ãƒ¡ãƒ­ãƒ‡ã‚£: E4 â†’ G4 â†’ A4
              â†‘é•·3åº¦â†‘  â†‘é•·2åº¦â†‘

ç§»èª¿å¾Œ:      C#4 â†’ E4 â†’ F#4  (æ­£ã—ã„ç§»èª¿)
              â†‘é•·3åº¦â†‘  â†‘é•·2åº¦â†‘  â† åº¦æ•°ãŒåŒã˜ï¼

é–“é•ã£ãŸæ“ä½œ: C#4 â†’ E4 â†’ F#4  (åå‰ã ã‘ä»˜ã‘æ›¿ãˆ)
              å®Ÿéš›ã®åº¦æ•°é–¢ä¿‚ãŒç ´å£Šã•ã‚Œã‚‹å¯èƒ½æ€§
```

### å‘¨æ³¢æ•°æ¯”ã®æ•°å­¦

å¹³å‡å¾‹ã§ã¯ã€1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ– = 12åŠéŸ³ = å‘¨æ³¢æ•°2å€ã€‚

```
1åŠéŸ³ä¸Š = Ã— 2^(1/12) â‰ˆ 1.0595
1åŠéŸ³ä¸‹ = Ã— 2^(-1/12) â‰ˆ 0.9439
```

ã“ã®ä¿‚æ•°ã‚’**ã™ã¹ã¦ã®éŸ³ã«å‡ç­‰ã«ã‹ã‘ã‚‹**ã“ã¨ã§ã€åº¦æ•°é–¢ä¿‚ãŒè‡ªå‹•çš„ã«ä¿æŒã•ã‚Œã‚‹ã€‚

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ç§»èª¿ã‚’å®Ÿè£…ã™ã‚‹ã¨ãï¼š

- [ ] `transposeFactor = pow(2.0, n / 12.0)` ã‚’å®šç¾©ã—ãŸ
- [ ] å‘¨æ³¢æ•°ã‚’ä½¿ã†**ã™ã¹ã¦ã®ç®‡æ‰€**ã§ä¿‚æ•°ã‚’ã‹ã‘ãŸ
- [ ] Pitch enumã¯**ä¸€åˆ‡å¤‰æ›´ã—ã¦ã„ãªã„**
- [ ] ãƒ¡ãƒ­ãƒ‡ã‚£é…åˆ—ã¯**ä¸€åˆ‡å¤‰æ›´ã—ã¦ã„ãªã„**
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã«ç§»èª¿é‡ã‚’æ˜è¨˜ã—ãŸ

---

## JupiterMelodySignal ã§ã®å®Ÿè£…ä¾‹

```swift
/// Transpose factor: -2 semitones for warmer, less piercing sound
/// 2^(-2/12) â‰ˆ 0.8909
let transposeFactor: Float = pow(2.0, -2.0 / 12.0)

func sample(at t: Float) -> Float {
    // ...
    if let index = findNoteIndex(at: cycleTime) {
        let note = melody[index]

        // Apply transpose factor to frequency
        // Structure unchanged, pitch lowered
        let transposedFreq = note.freq * transposeFactor

        let envelope = calculateLegatoEnvelope(...)
        let gainReduction = calculateHighFreqReduction(freq: transposedFreq)
        totalSignal += generateTone(freq: transposedFreq, t: t) * envelope * gainReduction
    }
    // ...
}
```

---

## Related Documents

- `_guide-audio-smoothness.md` â€” éŸ³ã®æ»‘ã‚‰ã‹ã•ã‚¬ã‚¤ãƒ‰
- `_guide-signal-envelope-utils.md` â€” SignalEnvelopeUtils APIè©³ç´°

---

## Revision History

| Date | Version | Change |
|------|---------|--------|
| 2025-11-30 | 1.0 | åˆç‰ˆä½œæˆï¼ˆç§»èª¿ãƒŸã‚¹ã‹ã‚‰ã®å­¦ã³ï¼‰ |
