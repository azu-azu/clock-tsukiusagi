# Jupiter トランペット高次倍音干渉問題の修正レポート

**Date**: 2025-12-01
**Issue**: トランペット音色の高次倍音（7-8倍音）がノート重複時に干渉し雑音が発生
**Status**: Resolved

---

## 問題の症状

Jupiter メロディの Section 4（トランペット音色）で、Bar 20 beat 2.0 の後に「ブーン」「ジリジリ」という不快な雑音が発生。

**問題が発生した箇所:**
- Bar 20 beat 2.0 (G5) → Bar 21 beat 0.0 (E5) の遷移時

---

## 原因特定のプロセス

### 最初の仮説

1. **Trumpet → Clarinet クロスフェードの問題** → 誤り
   - クロスフェードをコメントアウトしても問題継続

### 正しい原因の特定方法

**倍音設定の切り分けテスト:**

```swift
// トランペットの倍音をオルガンと同じに変更
let trumpetHarmonics: [Float] = [1.0, 2.0, 3.0, 4.0, 6.0]  // 元は8倍音
let trumpetHarmonicAmps: [Float] = [1.0, 0.45, 0.25, 0.12, 0.03]
```

**結果: 雑音が消えた → 高次倍音（5-8倍音）が原因**

---

## 根本原因

### 高次倍音の周波数干渉（ビート現象）

Bar 20 beat 2.0 の **G5 (783.99 Hz)** と Bar 21 beat 0.0 の **E5 (659.25 Hz)** が重なる瞬間、各倍音の周波数が近接して「うなり（ビート）」が発生。

**元のトランペット設定（8倍音）での周波数:**

| 倍音 | G5の周波数 | E5の周波数 | 差分 |
|------|-----------|-----------|------|
| 1倍音 | 784 Hz | 659 Hz | 125 Hz |
| 2倍音 | 1,568 Hz | 1,318 Hz | 250 Hz |
| 3倍音 | 2,352 Hz | 1,977 Hz | 375 Hz |
| 4倍音 | 3,136 Hz | 2,636 Hz | 500 Hz |
| 5倍音 | 3,920 Hz | 3,296 Hz | 624 Hz |
| 6倍音 | 4,704 Hz | 3,955 Hz | 749 Hz |
| **7倍音** | **5,488 Hz** | **4,614 Hz** | **874 Hz** |
| **8倍音** | **6,272 Hz** | **5,273 Hz** | **999 Hz** |

### なぜ高次倍音が問題を起こすか

1. **周波数差が可聴域のビートを生成**
   - 2つの近い周波数が同時に鳴ると、差分の周波数で「うなり」が発生
   - 例: G5の6倍音(4704Hz) と E5の7倍音(4614Hz) → 90Hzのビート

2. **高次倍音の組み合わせ爆発**
   - 8倍音 × 8倍音 = 64通りの周波数ペア
   - 多くの近接ペアが同時にビートを起こし、複雑な干渉パターンが発生

3. **リリース中の重複**
   - G5のリリース（0.18秒）中にE5のアタックが開始
   - この重複時間に干渉が集中

---

## 解決策

### 1. 倍音を6個に制限

```swift
// Before: 8倍音（干渉ノイズあり）
let trumpetHarmonics: [Float] = [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0]
let trumpetHarmonicAmps: [Float] = [1.0, 0.7, 0.5, 0.35, 0.25, 0.18, 0.13, 0.1]

// After: 6倍音（干渉ノイズ解消）
let trumpetHarmonics: [Float] = [1.0, 2.0, 3.0, 4.0, 5.0, 6.0]
let trumpetHarmonicAmps: [Float] = [1.0, 0.55, 0.35, 0.2, 0.12, 0.06]
```

### なぜ6倍音で十分か

- **聴覚的な明るさは維持**: 5-6倍音で十分「トランペットらしい」輝きがある
- **干渉リスクの低減**: 高周波域のペア数が減少
- **振幅の調整**: オルガンより明るめだが、控えめに設定

### 2. Trumpet→Clarinet クロスフェードの削除

倍音を減らしても、クロスフェードを有効にすると雑音が再発した。

**原因**: クロスフェード中は2つの音色（トランペット + クラリネット）が同時発音される。
- トランペット: 6倍音
- クラリネット: 5倍音（奇数のみ）
- 合計: 11個の周波数が同時に鳴る → 干渉ペアが大幅増加

**結論**: 異なる音色間のクロスフェードは、倍音の組み合わせが爆発的に増え、
ビート干渉のリスクが高い。トランペット→クラリネットは瞬時切り替えを採用。

---

## 試して効果がなかったアプローチ

| アプローチ | 結果 | 理由 |
|-----------|------|------|
| クロスフェード開始位置の調整 | 効果なし | 高次倍音が主因だった |
| Trumpet→Clarinet クロスフェード | 雑音再発 | 2音色同時発音で干渉増加 |

---

## 学び

### 1. 加算合成での倍音数は控えめに

倍音が多いほど音色は豊かになるが、**ノート重複時の干渉リスクも増大**する。
特に高次倍音（7倍音以上）は可聴域で複雑なビートを生成しやすい。

### 2. ビート現象の発生条件

2つの周波数 f1, f2 が同時に鳴ると、差分 |f1 - f2| の周波数でビートが発生。
- 差分 < 20Hz: 「うなり」として認識
- 差分 20-200Hz: 「ガサガサ」「ブーン」という不快な雑音
- 差分 > 200Hz: 別々の音として認識

### 3. 倍音設計の指針

| 楽器タイプ | 推奨倍音数 | 理由 |
|-----------|-----------|------|
| オルガン | 4-5個 | 温かみ重視、干渉リスク低 |
| トランペット | 5-6個 | 明るさと安全性のバランス |
| クラリネット | 4-5個（奇数のみ） | 奇数倍音で独特の空洞感 |

### 4. 異なる音色間のクロスフェードは避ける

同じ音色内のクロスフェード（例: Gymnopédie → Organ）は問題ない。
しかし、**異なる倍音構成を持つ音色間**のクロスフェードは干渉リスクが高い。

- **安全**: 同系統の音色（純音 → 純音+倍音）
- **危険**: 異系統の音色（全倍音 × 奇数倍音）

音色変更は**瞬時切り替え**が安全。自然な遷移が必要な場合は、
フェードアウト → 無音 → フェードインのギャップを設ける。

---

## 関連ファイル

- `TsukiSound/Core/Audio/Synthesis/PureTone/Jupiter/JupiterSignal.swift`

---

## 関連コミット

- (このレポートと同時にコミット予定)
