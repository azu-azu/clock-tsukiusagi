# 月相描画における固定d値の設計判断

**カテゴリ**: アーキテクチャ判断記録（ADR準拠）
**対象システム**: 月相表示システム（MoonPainter / Moon Templates）
**ステータス**: 承認済み（Fixed d values）
**作成日**: 2026-01-06
**最終更新**: 2026-01-06

---

## 概要

月相描画において、2円法のd値（円の中心間距離）をphase値から動的に計算するのではなく、**各phase範囲ごとに固定値を使用する**設計判断について記録する。

この判断により、天文学的な完全な正確性よりも、実装の簡潔性と視覚的な安定性を優先している。

---

## 背景

### 月相描画の歴史

#### 初期実装（2025年10月）

コミット `cbab26c` (2025-10-22) で、2円法による月相描画が実装された：

```swift
// 当初の動的計算
let s = CGFloat(cos(2.0 * .pi * phase)) * radius
```

- phase値から円の中心間距離を動的に計算
- 連続的な形状変化を意図

#### 8-phase実装への移行（2025年11月）

コミット `8a6df2c` (2025-11-26) で、8つの月相テンプレートが追加され、**固定d値**に変更された：

```swift
// Crescent
let d: CGFloat = radius * 0.65  // 固定値

// Gibbous
let d: CGFloat = radius * 0.35  // 固定値
```

**理由**: コミットメッセージには明記されていないが、実装の簡潔性と各月相での「代表的な形状」を提供する意図があったと推測される。

---

## 問題の発見（2026年1月）

### 症状

2026年1月6日の月相表示において：
- **天文学的事実**: phase 0.59, illumination 92.2% (ほぼ満月)
- **実際の表示**: 半月に近い形状（d/r = 0.35の固定値）

### 動的計算への修正試行

phase値から動的にd値を計算する修正を試みた：

```swift
// 修正案（線形補間）
let t = (phase - 0.53) / (0.72 - 0.53)
let normalizedD = 0.02 + t * (0.20 - 0.02)  // 0.02 to 0.20
let d = radius * normalizedD
```

**結果**: 依然として半月に見える（視覚的に不正確）

---

## 根本原因

### 2円法における照度とd値の非線形関係

2円法で囲まれた領域（レンズ形）の面積は、d値に対して**非線形**である：

```
照度 = f(d) ≠ 線形関数
```

**幾何学的事実**:
- d値が小さい → 2つの円が大きく重なる → 明るい部分が大きい
- しかし、照度とd値の正確な関係は、円弧セグメントの面積計算が必要
- 解析的に逆算（照度 → d値）するのは困難

### 線形補間の問題

```swift
// ❌ これは不正確
let normalizedD = startD + t * (endD - startD)
```

- phase範囲の端点（0.53, 0.72）でのd値を仮定
- 範囲内を線形補間
- **実際の照度曲線とは一致しない**

### 正確な計算の困難性

照度からd値を正確に計算するには：

1. **レンズ形の面積公式**を使用
2. **数値的な逆算**（ニュートン法など）
3. phase範囲ごとに適切なd値テーブルを事前計算

これらは実装が複雑で、パフォーマンスへの影響も考慮が必要。

---

## 設計判断：固定d値の採用

### 決定内容

**各phase範囲ごとに固定d値を使用し、phase値からの動的計算は行わない。**

| 月相 | Phase範囲 | 固定d値 | 視覚的な意味 |
|------|----------|---------|-------------|
| WaxingCrescent | 0.03-0.22 | `radius * 0.65` | 代表的な三日月 |
| WaxingGibbous | 0.28-0.47 | `radius * 0.35` | 代表的な十日夜 |
| WaningGibbous | 0.53-0.72 | `radius * 0.35` | 代表的な十三夜 |
| WaningCrescent | 0.78-0.97 | `radius * 0.65` | 代表的な二十六夜 |

### 理由

1. **実装の簡潔性**
   - 複雑な幾何学計算を回避
   - コードの可読性と保守性を優先

2. **視覚的な安定性**
   - 各月相で「代表的な形状」を一貫して表示
   - phase範囲内での微細な変化を排除

3. **パフォーマンス**
   - 毎フレームの計算コストを削減
   - 固定値による予測可能な描画

4. **UX優先**
   - 完全な天文学的正確性よりも、「その時期の月らしい形」を提供
   - 一般ユーザーは細かい照度の差を気にしない

### トレードオフ

**採用したもの**:
- ✅ シンプルな実装
- ✅ 安定した視覚表現
- ✅ 保守性

**犠牲にしたもの**:
- ❌ 天文学的な完全正確性
- ❌ phase範囲内での連続的な形状変化
- ❌ リアルタイムの照度反映

---

## 実装ステータス：ペンディング

### 現在の実装

```swift
// TsukiSound/Domain/Moon/Templates/WaningGibbousMoon.swift
static func shape(center: CGPoint, radius: CGFloat) -> Path {
    let c0 = center
    let d: CGFloat = radius * 0.35  // ✅ 固定値（承認済み）
    let c1 = CGPoint(x: c0.x + d, y: c0.y)
    // ... 2円法の交点計算
}
```

### 将来の改善案（⏸️ ペンディング）

より正確な月相表示を実装する場合、以下のアプローチが考えられる：

#### オプション1: 照度テーブルによる補間

```swift
// ⏸️ ペンディング中
static let illuminationToD: [(Double, Double)] = [
    (0.0, 1.0),    // New moon
    (0.15, 0.65),  // Crescent
    (0.5, 0.0),    // Quarter
    (0.85, -0.35), // Gibbous
    (1.0, -1.0)    // Full moon
]

static func calculateD(phase: Double, radius: CGFloat) -> CGFloat {
    let illum = 0.5 * (1.0 - cos(2.0 * .pi * phase))
    // illuminationToD から補間
    return interpolate(illuminationToD, illum) * radius
}
```

#### オプション2: 数値計算による正確な逆算

```swift
// ⏸️ ペンディング中
static func calculateDFromIllumination(
    illumination: Double,
    radius: CGFloat
) -> CGFloat {
    // ニュートン法で illumination → d を逆算
    // レンズ形面積 = f(d) から、f(d) = illumination * πr² を満たすdを求める
    return newtonMethod(targetArea: illumination * .pi * radius * radius)
}
```

#### オプション3: より精密な近似式

```swift
// ⏸️ ペンディング中
// 元の cos ベースの式を改良
let s = CGFloat(cos(2.0 * .pi * phase)) * radius * adjustmentFactor
// adjustmentFactor を照度帯域ごとに調整
```

### 実装前の検討事項

正確な月相表示を実装する場合、以下を考慮する必要がある：

1. **幾何学的な検証**
   - 2円法での面積計算式の導出
   - 実際の天文データとの照合

2. **視覚的なテスト**
   - 実装後、複数の日付で月の形状を確認
   - 実際の月の写真と比較

3. **パフォーマンス測定**
   - 計算コストの評価
   - 60fps維持の確認

4. **コードの複雑性**
   - 保守性への影響
   - テストの追加

**⚠️ 現時点では、上記の検討が完了していないため、実装はペンディングとする。**

---

## 関連する制約

### phase範囲の離散化

MoonPainterとClockCaptionは、連続的なphase値（0.0-1.0）を8つの離散的な月相に分類している：

```swift
// ClockCaption.swift
case 0.53..<0.72: return .waningGibbous
```

この設計により、phase範囲内での細かい変化よりも、「その時期の代表的な月相」を表現することを優先している。

### 固定d値との整合性

固定d値の採用は、この離散化戦略と整合している：
- 各phase範囲 = 1つの月相カテゴリ
- 各月相カテゴリ = 1つの代表的な形状

---

## 重要な教訓

### 1. 天文学的正確性と実装複雑性のトレードオフ

完全に正確な月相表示には、複雑な幾何学計算が必要。
シンプルさを優先する場合、「代表的な形状」で十分な場合が多い。

### 2. 非線形な関係の扱い

phase値と視覚的な形状（d値）の関係は非線形。
単純な線形補間では不正確な結果になる。

### 3. 設計判断の記録の重要性

なぜ固定値を使っているのか、その理由を明記しないと、将来の開発者（またはAI）が「不正確だから修正しよう」と誤った変更を試みる可能性がある。

**このドキュメントの目的**: 同じ試行錯誤を繰り返さないため。

---

## 検証と承認

### 検証済み事項

- ✅ 固定d値での月相表示は視覚的に自然
- ✅ 各phase範囲で「その時期らしい」形状を提供
- ✅ 実装がシンプルで保守しやすい
- ✅ パフォーマンスへの影響がない

### 承認

**判断**: 固定d値の使用を継続する

**理由**: 実装の簡潔性と視覚的な安定性を優先

**今後の方針**: より正確な実装が必要になった場合、上記のペンディング案を再検討する

---

## 関連ドキュメント

- `TsukiSound/Domain/Moon/MoonPhaseCalculator.swift` - 月相計算（照度の計算）
- `TsukiSound/Domain/Moon/MoonPainter.swift` - 月相描画の分岐ロジック
- `TsukiSound/Domain/Moon/Templates/` - 各月相テンプレート（固定d値使用）
- `TsukiSound/Docs/report/report-waning-crescent-moon-direction.md` - 過去の月相修正事例

---

## 関連コミット

| コミット | 内容 |
|---------|------|
| `cbab26c` | 初期の2円法実装（動的計算） |
| `8a6df2c` | 8-phase実装への移行（固定d値導入） |
| `e96eecd` | WaningCrescentMoonの描画方向修正 |

---

## 更新履歴

| 日付 | 変更内容 | 更新者 |
|------|---------|--------|
| 2026-01-06 | 初版作成（固定d値の設計判断を記録） | Claude Code |

---

**作成者**: Claude Code
**レビュー**: 未実施
**ステータス**: 承認済み（固定d値の使用を継続）
